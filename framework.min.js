$JSKK.Class.create({$namespace:"framework",$name:"Component",$uses:[$JSKK.trait.Observable]})({initQueue:function(a,b){var c=$JSKK.toArray(arguments);Object.isDefined(c[1])&&(Object.isFunction(c.last())&&(b=c.pop()),a=c);var d=-1,e=null,f=function(){d++;Object.isUndefined(a[d])?Object.isFunction(b)&&b():Object.isArray(a[d])?(e=Object.isFunction(a[d][0].$reflect)?a[d][0]:new a[d][0],Object.isAssocArray(a[d][1])?e.observeOnce("onAfterInit",function(){e.getController("State").observeOnce("onReadyState",
function(){f()})}.bind(this,d)):f(),e.configure(a[d][1])):(Object.isAssocArray(a[d])||new a[d],f())};f()}},{events:{onConfigured:true,onAfterInit:true},config:{attachTo:null},browser:{name:null,version:null},components:{},stores:[],views:[],controllers:[],_stores:{},_views:{},_controllers:{},_configured:false,my:{name:null,index:null,NSObject:null},radioTower:null,stateMgr:null,viewCache:null,readyForConfig:false,_iid:null,init:function(){this.my.name=this.$reflect("name");this.my.namespace=this.$reflect("namespace").split(".");
if(Object.isUndefined(window.framework.$components))window.framework.$components={};Object.isUndefined(window.framework.$components[this.my.name])&&(window.framework.$components[this.my.name]=[]);this.my.index=window.framework.$components[this.my.name].push(this);this.my.NSObject=window;for(var a=0,b=this.my.namespace.length;a<b;a++)this.my.NSObject=this.my.NSObject[this.my.namespace[a]];this.initRadioTower();this.initStateMgr();this.initViewCache();this.generateInstanceID();$JSKK.when(this.isConfigured.bind(this)).isTrue(function(){this.generateInstanceID();
this.insertBaseContainer();this.initChildComponents();this.initStores();this.initViews();this.initControllers();this.fireEvent("onAfterInit",this)}.bind(this));Object.isFunction(this.initCmp)&&this.initCmp();this.readyForConfig=true},initRadioTower:function(){if(Object.isUndefined(window.framework.$radioTower))window.framework.$radioTower=new framework.RadioTower;this.radioTower=window.framework.$radioTower},initStateMgr:function(){if(Object.isUndefined(window.framework.$stateMgr))window.framework.$stateMgr=
new framework.StateMgr;this.stateMgr=window.framework.$stateMgr},initViewCache:function(){if(Object.isUndefined(window.framework.$viewCache))window.framework.$viewCache=new framework.mvc.ViewCache;this.viewCache=window.framework.$viewCache},getViewCache:function(){return this.viewCache},getBrowser:function(){if(Object.isNull(this.browser.name)){if(Object.isDefined(jQuery.browser.msie))this.browser.name="ie";else if(Object.isDefined(jQuery.browser.webkit))this.browser.name="webkit";else if(Object.isDefined(jQuery.browser.opera))this.browser.name=
"opera";else if(Object.isDefined(jQuery.browser.mozilla))this.browser.name="mozilla";this.browser.version=jQuery.browser.version.split(".")[0]}},initChildComponents:function(){var a=null,b=null,c;for(c in this.components){a=this.components[c].split(".");b=window[a[0]];if(Object.isDefined(b))for(var d=1,e=a.length;d<e;d++)if(Object.isDefined(b[a[d]]))b=b[a[d]];else throw Error('Error! component "'+this.components[c]+'" not loaded.');else throw Error('Error! component "'+this.components[c]+'" not loaded.');
this.components[c]=new b}},newChildComponent:function(a){var b=a.split("."),c=window[b[0]];if(Object.isDefined(c))for(var d=1,e=b.length;d<e;d++)if(Object.isDefined(c[b[d]]))c=c[b[d]];else throw Error('Error! component "'+this.components[a]+'" not loaded.');else throw Error('Error! component "'+this.components[a]+'" not loaded.');Object.isDefined(this.components[a])||(this.components[a]=[]);b=new c;this.components[a].push(b);return b},getCmp:function(a){if(Object.isDefined(this.components[a]))return this.components[a];
else throw Error('Unable to get component "'+a+'". This component has not been registered.');},initControllers:function(){var a=null;if(Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()].controller.State)){a=this._controllers.State=new (this.my.NSObject[this.my.name.lowerFirst()].controller.State)(this);a.observeOnce("onBeforeReadyState",function(){this.sendSignal(framework.Signal.COMPONENT_IS_READY,"component",{origin:this.getIID()},this)}.bind(this));for(var a=0,b=this.controllers.length;a<
b;a++)if(Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()].controller[this.controllers[a]]))this._controllers[this.controllers[a]]=new (this.my.NSObject[this.my.name.lowerFirst()].controller[this.controllers[a]])(this);else throw Error('Error controller "'+this.controllers[a]+'" not loaded on component "'+this.my.name+'".');}else throw Error('State controller has not been loaded for component "'+this.my.name+'". A component MUST have a state store and controller.');},getController:function(a){if(Object.isDefined(this._controllers[a]))return this._controllers[a];
else throw Error('Error - controller "'+a+'" has not been initilized on component "'+this.my.name+'".');},initViews:function(){for(var a=0,b=this.views.length;a<b;a++)if(Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()])&&Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()].view)&&Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()].view[this.views[a]]))this._views[this.views[a]]=new (this.my.NSObject[this.my.name.lowerFirst()].view[this.views[a]])(this);else throw Error('Error - view "'+
this.views[a]+'" not loaded on component "'+this.my.name+'".');},getView:function(a){if(Object.isDefined(this._views[a]))return this._views[a];else throw Error('Error - view "'+a+'" has not been initilized on component "'+this.my.name+'".');},initStores:function(){if(Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()].store.State)){this._stores.State=new (this.my.NSObject[this.my.name.lowerFirst()].store.State)(this);for(var a=0,b=this.stores.length;a<b;a++)if(Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()])&&
Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()].store[this.stores[a]]))this._stores[this.stores[a]]=new (this.my.NSObject[this.my.name.lowerFirst()].store[this.stores[a]])(this);else throw Error('Error - store "'+this.stores[a]+'" not loaded for component "'+this.my.name+'".');}else throw Error('State store has not been loaded for component "'+this.my.name+'". A component MUST have a state store and controller.');},getStore:function(a){if(Object.isDefined(this._stores[a]))return this._stores[a];
else throw Error('Error - store "'+a+'" has not been initilized for component "'+this.my.name+'".');},insertBaseContainer:function(){$(this.getConfig("attachTo")||"body")[this.getConfig("attachHow")||"append"](["<div",' class="'+this.$reflect("namespace").replace(/\./g,"-")+"-"+this.$reflect("name")+'-container"',' id="'+this.getIID()+'"',' style="display:none;"></div>'].join(""))},generateInstanceID:function(){for(var a="0123456789abcdefghijklmnopqrstuvwxyz".split(""),b=[],c=0;c<8;c++)b.push(a[Math.floor(Math.random()*
25)]);this._iid=this.getSafeID()+"-"+b.join("")},getIID:function(){return this._iid},getSafeID:function(){return(this.$reflect("namespace")+"."+this.$reflect("name")).replace(/\./g,"-")},configure:function(a){$JSKK.when(this,"readyForConfig").isTrue(function(){Object.isDefined(this.config)?Object.extend(this.config,a):this.config=a;this._configured=true;this.fireEvent("onConfigured",this);this.sendSignal(framework.Signal.CMP_DO_RECONFIGURE,{component:this.my.name})}.bind(this))},reconfigure:function(){$JSKK.when(this,
"readyForConfig").isTrue(function(){this.configure(this.config)}.bind(this))},isConfigured:function(){return this._configured},getConfig:function(a){for(var a=a.split("."),b=this.config,c=0,d=a.length;c<d;c++)if(Object.isDefined(b[a[c]]))b=b[a[c]];else return null;return b},getID:function(){var a=[];Object.extend(a,this.namespace);a.push(this.className);return a.join(".")},sendSignal:function(a,b,c,d){if(Object.isEmpty(a))throw Error("Class "+this.className+" attempted to fire an empty signal.");
else $JSKK.when(this,"radioTower").isAssocArray(function(){this.radioTower.fireEvent(a,new framework.Signal({name:a,body:d,type:b,filter:c}))}.bind(this))}});$JSKK.Class.create({$namespace:"framework",$name:"RadioTower",$uses:[$JSKK.trait.Observable]})({},{events:{}});$JSKK.Class.create({$namespace:"framework",$name:"Signal"})({LOCAL:"local",GLOBAL:"global",COMPONENT_IS_READY:"component.ready",STATE_CHANGE:"state.change",CMP_DO_RECONFIGURE:"component.do.reconfigure"},{config:{name:null,body:null,type:null,filter:{}},init:function(a){this.config.name=a.name||null;this.config.body=a.body||null;this.config.type=a.type||null;this.config.filter=a.filter||{}},getName:function(){return this.config.name},getBody:function(){return this.config.body},getType:function(){return this.config.type},
getFilter:function(){return this.config.filter},isForMe:function(a,b){if(!Object.isNull(a)&&this.getType()!=a)return false;if(!Object.isNull(b)){var c=this.getFilter(),d;for(d in b)if(Object.isUndefined(c[d])||b[d]!=c[d])return false}return true}});$JSKK.Class.create({$namespace:"framework",$name:"StateMgr",$uses:[framework.trait.signal.Send]})({},{state:{},stateString:"",radioTower:null,eventSupported:false,supressNext:false,init:function(){this.radioTower=framework.$radioTower;$(window).bind("hashchange",this.onHashChangeTest.bind(this));this.onHashChange(null,true);var a=window.location.hash;window.location.hash="welcome";(function(){window.location.hash=a;this.bindHashEvent.defer(200,this)}).bind(this).defer(100)},onHashChangeTest:function(){this.eventSupported=
true},bindHashEvent:function(){this.eventSupported?$(window).bind("hashchange",this.onHashChange.bind(this)):this.monitorHashChange()},monitorHashChange:function(){$JSKK.when(function(){return window.location.hash.replace("#","")!=this.stateString}.bind(this)).isTrue(function(){this.onHashChange();this.monitorHashChange()}.bind(this))},onHashChange:function(a,b){if(this.supressNext)b=true,this.supressNext=false;this.stateString=window.location.hash.replace("#","");this.state=Object.isEmpty(this.stateString)?
{}:this.parseStateString(this.stateString);b||this.sendSignal(framework.Signal.STATE_CHANGE,"state",{},this.state)},registerStateChanger:function(a,b){b=this.parseStateString(b);a.click(this.updateState.bind(this,b,false))},updateState:function(a){for(var b in a)this.state[b]=a[b];window.location.hash=this.parseStateObject(this.state)},getState:function(){return this.state},parseStateString:function(a){for(var a=a.split("&"),b=null,c={},d=0,e=a.length;d<e;d++){b=a[d].split("=");if(["true","false"].inArray(b[1]))switch(b[1]){case "true":b[1]=
true;break;case "false":b[1]=false}c[b[0]]=b[1]}return c},parseStateObject:function(){var a=[],b;for(b in this.state)a.push(b+"="+this.state[b]);return a.join("&")},getRadioTower:function(){return this.radioTower}});$JSKK.Class.create({$namespace:"framework.data",$name:"AbstractStore",$abstract:true,$uses:[framework.trait.ComponentConnector,$JSKK.trait.Observable]})({},{events:{onChange:true,onSync:true,onSyncFailed:true,onModelChange:true,onModelLockChange:true},proxy:null,model:null,data:{},record:null,transactions:[],init:function(){if(Object.isNull(this.proxy))this.proxy=new framework.data.proxy.MemoryProxy},newRecord:function(a){return new this.model({onLockChange:function(a,c){this.fireEvent("onModelLockChange",
this,a,c)}.bind(this)},a)},bindchangeEvent:function(a){a.observe("onChange",function(a){if(this.isModelInAnyTransaction(a)){for(var c=false,d=0,e=this.transactions.length;d<e;d++){if(c)break;for(var f=0,g=this.transactions[d].models.length;f<g;f++)if(this.transactions[d].models[f]==a){c=d;break}}if(c!==false)this.transactions[c].models.length===1?(this.releaseModelFromTransaction(a,this.transactions[c].transaction),this.releaseTransaction(this.transactions[c].transaction),this.fireEvent("onChange",
this,a)):this.releaseModelFromTransaction(a,this.transactions[c].transaction);else throw Error("Unable to locate a model within a transaction. BTW, this should never happen! IOW - You're screwed :)");}else this.fireEvent("onModelChange",this,a),this.fireEvent("onChange",this,a)}.bind(this))},getModel:function(){return this.model},get:$JSKK.Class.ABSTRACT_METHOD,set:$JSKK.Class.ABSTRACT_METHOD,sync:$JSKK.Class.ABSTRACT_METHOD,setProxy:function(a){this.proxy=a;return this},getProxy:function(){return this.proxy},
isDirty:$JSKK.Class.ABSTRACT_METHOD,informModelIsInTransaction:function(a,b){this.hasRecordedTransaction(b)||this.recordTransaction(b);if(this.isModelInAnyTransaction(a)&&!this.isModelInTransaction(a,b))throw Error("A model cannot be attached to two transactions at any given time.");this.isModelInTransaction(a,b)||this.recordModelInTransaction(a,b)},hasRecordedTransaction:function(a){for(var b=0,c=this.transactions.length;b<c;b++)if(this.transactions[b].transaction==a)return true},recordTransaction:function(a){this.transactions.push({transaction:a,
models:[]});return this},releaseTransaction:function(a){for(var b=[],c=0,d=this.transactions.length;c<d;c++)this.transactions[c].transaction!=a&&b.push(this.transactions[c]);this.transactions=b;return this},isModelInTransaction:function(a,b){for(var c=0,d=this.transactions.length;c<d;c++)if(this.transactions[c].transaction==b)for(var e=0,f=this.transactions[c].models.length;e<f;e++)if(this.transactions[c].models[e]==a)return true;return false},isModelInAnyTransaction:function(a){for(var b=0,c=this.transactions.length;b<
c;b++)for(var d=0,e=this.transactions[b].models.length;d<e;d++)if(this.transactions[b].models[d]==a)return true;return false},recordModelInTransaction:function(a,b){for(var c=0,d=this.transactions.length;c<d;c++)if(this.transactions[c].transaction==b){this.transactions[c].models.push(a);break}return this},releaseModelFromTransaction:function(a,b){for(var c=[],d=0,e=this.transactions.length;d<e;d++)if(this.transactions[d].transaction==b){for(var e=0,f=this.transactions[d].models.length;e<f;e++)this.transactions[d].models[e]!=
a&&c.push(this.transactions[d].models[e]);this.transactions[d].models=c;break}return this}});$JSKK.Class.create({$namespace:"framework.data",$name:"BTL",$uses:[$JSKK.trait.Configurable]})({APIMethod:function(a,b,c){this.proxy.raw({url:this.config.url,data:{call:a,data:b},onComplete:function(a){Object.isFunction(c)&&c(a)}.bind(this)})}},{config:{url:"",proxy:framework.data.proxy.BTL},ready:false,proxy:null,API:{},queue:null,init:function(){this.proxy=new this.config.proxy({url:this.config.url});this.getServiceAPI()},onReady:function(a){$JSKK.when(this,"ready").isTrue(a)},getServiceAPI:function(){$.ajax({type:"GET",
url:this.config.url}).done(this.createAPIMethods.bind(this)).fail(function(){console.debug("SERVICE LOAD ERROR",arguments)})},createAPIMethods:function(a){var b=null,c=0,d=0;for(b in a){this.API[b]={};for(c=0,d=a[b].length;c<d;c++)this.API[b][a[b][c]]=this.$reflect("self").APIMethod.bind(this,b+"."+a[b][c])}this.ready=true},setProxy:function(a,b){this.proxy=new this.config.proxy({url:b||this.config.url});return this},bindType:function(a,b){a._type=b;return this},startQueue:function(){this.queue=new framework.data.Queue;
this.queue.attachProxy(this.proxy);return this},executeQueue:function(){this.queue.execute();return this}});$JSKK.Class.create({$namespace:"framework.data",$name:"MultiModelStore",$extends:framework.data.AbstractStore,$abstract:true})({},{BTL:null,BTL_GET:null,BTL_SET:null,model:null,data:[],records:[],init:function(){this.init.$parent();if(!Object.isNull(this.model)&&Object.isDefined(this.model)){this.records=this.newRecord(this.data);for(var a=0,b=this.records.length;a<b;a++)this.bindchangeEvent(this.records[a]);delete this.data}else throw Error('Store "'+this.$reflect("namespace")+"."+this.$reflect("name")+
'" must be configured with a valid model.');},newRecord:function(a){Object.isArray(a)||(a=[a]);for(var b=[],c=0,d=0,e=a.length;d<e;d++)c=b.push(this.newRecord.$parent(a[d])),b[c-1].bindStore(this);return b},each:function(a){this.records.each(a);return this},add:function(a){a.flagDirty();this.records.push(a);this.fireEvent("onChange",this);return this},remove:function(a){for(var b=[],c=0,d=this.records.length;c<d;c++)this.records[c]!=a&&b.push(this.records[c]);this.records=b;this.fireEvent("onChange",
this);return this},removeByRange:function(a,b){if(a<0||a>this.records.length)return console.log("StartIndex is out of range."),this;if(b<a)return console.log("EndIndex is invalid."),this;if(b>this.records.length)return console.log("EndIndex is out of range."),this;this.records.splice(a,b);this.fireEvent("onChange",this);return this},getRecordIndexByValue:function(a,b){var c=-1;this.each(function(d,e){d.getRecord()[a]==b&&(c=e)}.bind(this));return c},getRecordIndex:function(a){var b=-1;this.each(function(c,
d){c.getRecord()===a&&(b=d)}.bind(this));return b},getAll:function(){return this.records},getAt:function(a){return this.records[a]},first:function(){return this.getAt(0)},last:function(){return this.getAt(this.records.length-1)},get:function(){},set:function(){},getById:function(a){var b=null;this.each(function(c){if(c.getId()==a)return b=c,false}.bind(this));return b},find:function(){var a=$JSKK.toArray(arguments),b={},c=[];Object.isDefined(a[1])?b[a.shift()]=a.shift():b=a.shift();this.each(function(a){for(var e in b)if(a.get(e)!=
b[e])return false;c.push(a)}.bind(this));return c},findBy:function(a){var b=[];this.each(function(c){a(c)&&b.push(c)});return b},setAll:function(){var a=$JSKK.toArray(arguments),b={},c=new framework.data.Transaction;Object.isDefined(a[1])?b[a.shift()]=a.shift():b=a.shift();c.start();for(var a=null,d=0,e=this.records.length;d<e;d++)a=c.attachModel(this.records[d]),a.set(b);c.execute({onSuccess:function(){c.commit();this.fireEvent("onChange",this)}.bind(this),onFailure:function(){c.rollback()}});return this},
sync:function(){if(this.proxy&&Object.isFunction(this.proxy.sync)){var a=[];this.getDirty().each(function(b){a.push(b.getRecord())});this.proxy.sync({data:a,onSuccess:function(a){this.records=this.newRecord(a.data);for(var c=0,d=this.records.length;c<d;c++)this.bindchangeEvent(this.records[c]);this.fireEvent("onChange",this,a);this.fireEvent("onSync",this,a)}.bind(this),onFailure:function(a){this.fireEvent("onSyncFailed",this,a)}.bind(this)})}else if(Object.isAssocArray(this.BTL))a=[],this.getDirty().each(function(b){var c=
a.push(b.getRecord())-1;console.debug(c,a);a[c]=this.BTL.bindType(a[c],b.$reflect("name").toLowerCase())}.bind(this)),this.BTL.startQueue(),a.length&&this.BTL_SET(a),this.BTL_GET(null,function(a){this.records=this.newRecord(a);for(var c=0,d=this.records.length;c<d;c++)this.bindchangeEvent(this.records[c]);this.fireEvent("onChange",this,a);this.fireEvent("onSync",this,a)}.bind(this)),this.BTL.executeQueue();else throw Error('The store "'+this.$reflect("namespace")+"."+this.$reflect("name")+'" cannot be synced as it does not have a syncable proxy attached.');
},isDirty:function(){return Boolean(this.getDirty().length)},getDirty:function(){var a=[];this.records.each(function(b){b.isDirty()&&a.push(b)});return a},configureBTL:function(a){if(!Object.isAssocArray(a.handler))throw Error("Invalid BTL handler assigned with MultiModelStore.configureBTL().");if(!Object.isFunction(a.get))throw Error("Invalid getter assigned with MultiModelStore.configureBTL().");if(!Object.isFunction(a.set))throw Error("Invalid setter assigned with MultiModelStore.configureBTL().");
this.BTL=a.handler;this.BTL_GET=a.get;this.BTL_SET=a.set;return this}});$JSKK.Class.create({$namespace:"framework.data",$name:"Queue"})({},{proxies:[],requests:{},executing:false,nextSequence:1,attachProxy:function(a){this.proxies.inArray(a)||(this.proxies.push(a),a.observe("onBeforeRequest",function(a,c){if(this.executing)return true;if(Object.isDefined(c.url)){Object.isUndefined(this.requests[c.url])&&(this.requests[c.url]=[]);c.sequence=this.nextSequence++;c.proxy=a;if(!Object.isDefined(c.data))c.data=null;this.requests[c.url].push(c);delete c.url}return false}.bind(this)));
return this},execute:function(){this.executing=true;var a=null,b=[];for(a in this.requests){for(var c=0,d=this.requests[a].length;c<d;c++)this.requests[a][c].timestamp=Date.parse(new Date),b.push({sequence:this.requests[a][c].sequence,data:this.requests[a][c].data,timestamp:this.requests[a][c].timestamp});this.requests[a][0].proxy.raw({data:b,onSuccess:this.__onDone.bind(this),onFailure:this.__onDone.bind(this),onComplete:this.__onDone.bind(this)})}return this},__onDone:function(a){for(var b=null,
c=0,d=a.length;c<d;c++)if(b=this.getRequest(a[c].sequence),a[c].success){if(Object.isFunction(b.onComplete))b.onComplete(a[c].data);if(Object.isFunction(b.onSuccess))b.onSuccess(a[c].data)}else{if(Object.isFunction(b.onComplete))b.onComplete(a[c].data);if(Object.isFunction(b.onFailure))b.onFailure(a[c].data)}},push:function(a){this.requests[a.url].push(a);delete a.url;return this},getRequest:function(a){for(var b in this.requests)for(var c=0,d=this.requests[b].length;c<d;c++)if(this.requests[b][c].sequence==
a)return this.requests[b][c];return null}});$JSKK.Class.create({$namespace:"framework.data",$name:"SingleModelStore",$extends:framework.data.AbstractStore,$abstract:true})({},{init:function(){this.init.$parent();if(!Object.isNull(this.model)&&Object.isDefined(this.model))this.record=this.newRecord(this.data),this.bindchangeEvent(this.record),delete this.data;else throw Error('Store "'+this.$reflect("namespace")+"."+this.$reflect("name")+'" must be configured with a valid model.');},get:function(a){return this.record.get(a)},set:function(){this.record.set.apply(this.record,
$JSKK.toArray(arguments));return this},sync:function(){if(this.proxy&&Object.isFunction(this.proxy.sync)){var a=[];this.isDirty()&&(a=[this.record]);this.proxy.sync({data:a,onSuccess:function(a){this.record=this.newRecord(a.data[0]);this.fireEvent("onChange",this,a);this.fireEvent("onSync",this,a)}.bind(this),onFailure:function(a){this.fireEvent("onSyncFailed",this,a)}.bind(this)})}else throw new Exception('The store "'+this.$reflect("namespace")+"."+this.$reflect("name")+'" cannot be synced as it does not have a syncable proxy attached.');
return this},load:function(a){if(this.proxy&&Object.isFunction(this.proxy.get))this.proxy.get({filter:a,onSuccess:function(a){this.record=this.newRecord(a.data[0]);this.fireEvent("onChange",this,a);this.fireEvent("onLoad",this,a)}.bind(this),onFailure:function(a){this.fireEvent("onLoadFailed",this,a)}.bind(this)});else throw new Exception('The store "'+this.$reflect("namespace")+"."+this.$reflect("name")+'" cannot be synced as it does not have a syncable proxy attached.');return this},isDirty:function(){return this.record.isDirty()}});$JSKK.Class.create({$namespace:"framework.data",$name:"Transaction"})({STATE_INIT:0,STATE_STARTED:1,STATE_COMITTED:2,STATE_COMPLETE:4,STATE_SUCCESS:8,STATE_FAILED:16,STATE_ROLLEDBACK:32},{models:[],queue:false,state:0,lockState:"full",init:function(a){if(a!==false)this.queue=new framework.data.Queue},attachModel:function(a){if(Object.isDefined(a)&&Object.isFunction(a.$reflect)&&a.$reflect("extends")==framework.mvc.Model){var b=a.getStore();b&&b.informModelIsInTransaction(a,this);a.lock(this.lockState);
b=a.clone();a.attachPhantom(b);this.models.push(a);this.queue&&this.queue.attachProxy(a.getStore().getProxy());return b}else throw Error("Transactions can only be used with Models.");},start:function(){this.state|=framework.data.Transaction.STATE_STARTED;this.fullLock();return this},execute:function(a){var b={total:this.models.length,done:0,fails:0};$JSKK.when(b,{object:"done",value:b.total}).isEqualTo(function(){if(b.fails===0){if(Object.isFunction(a.onSuccess))a.onSuccess()}else if(Object.isFunction(a.onFailure))a.onFailure()}.bind(this));
this.models.each(function(a){var d=a.getPhantom();d.isDirty()&&a.getStore()&&d.bindStore(a.getStore()).sync({onSuccess:function(){b.done++},onFailure:function(){b.done++;b.fails++}}).unbindStore()});this.queue&&this.queue.execute();return this},commit:function(){this.state|=framework.data.Transaction.STATE_COMITTED;this.models.each(function(a,b){a.lock(framework.mvc.Model.LOCK_NONE);a.set(a.getPhantom().getRecord());a.destroyPhantom();delete this.models[b]}.bind(this));delete this.models;return this},
rollback:function(){this.state|=framework.data.Transaction.STATE_ROLLEDBACK;this.models.each(function(a,b){a.destroyPhantom();delete this.models[b]}.bind(this));delete this.models;return this},fullLock:function(){this.lockState="full";this.models.each(function(a){a.lock("full")});return this},readOnly:function(){this.lockState="readonly";this.models.each(function(a){a.lock("readonly")});return this}});$JSKK.Class.create({$namespace:"framework.data.proxy",$name:"AbstractProxy",$abstract:true,$uses:[$JSKK.trait.Configurable,$JSKK.trait.Observable]})({},{config:{url:""},events:{onBeforeRequest:true},raw:$JSKK.Class.ABSTRACT_METHOD,_onDone:$JSKK.Class.ABSTRACT_METHOD});$JSKK.Class.create({$namespace:"framework.data.proxy",$name:"Ajax",$extends:framework.data.proxy.AbstractProxy})({},{get:function(a){a.url=this.config.url;if(this.fireEvent("onBeforeRequest",this,a)!==false){if(Object.isUndefined(a.method))a.method="POST";$.get({type:a.method,url:a.url,data:a.filter||{}}).done(this._onDone.bind(this,a)).fail(a.onFailure||$JSKK.emptyFunction)}},sync:function(a){a.url=this.config.url;this.fireEvent("onBeforeRequest",this,a)!==false&&$.ajax({type:"POST",url:a.url,data:a.data||
{}}).done(this._onDone.bind(this,a)).fail(a.onFailure||$JSKK.emptyFunction)},raw:function(a){console.debug("RAW DATA:",$.stringify(a.data));a.url=this.config.url;this.fireEvent("onBeforeRequest",this,a)!==false&&$.ajax({type:"POST",contentType:"application/json",processData:false,url:a.url,data:$.stringify(a.data)||{}}).done(this._onDone.bind(this,a)).fail(a.onFailure||$JSKK.emptyFunction)},_onDone:function(a,b){b.success?(a.onSuccess||$JSKK.emptyFunction)(b):(a.onFailure||$JSKK.emptyFunction)(b)}});$JSKK.Class.create({$namespace:"framework.data.proxy",$name:"BTL",$extends:framework.data.proxy.AbstractProxy})({},{raw:function(a){a.url=this.config.url;this.fireEvent("onBeforeRequest",this,a)!==false&&$.ajax({type:"POST",contentType:"application/json",processData:false,url:a.url,data:$.stringify(a.data)||{}}).done(this._onDone.bind(this,a)).fail(function(){console.warn("BTL Proxies raw() method hasn't been confiugred to deal with failures.")});return this},_onDone:function(a,b){(a.onComplete||
$JSKK.emptyFunction)(b)}});$JSKK.Class.create({$namespace:"framework.data.proxy",$name:"DummyProxy",$extends:framework.data.proxy.MemoryProxy})({},{defaultResolver:function(a,b){return typeof a.data.id!=="undefined"&&typeof b.id!=="undefined"&&b.id==a.data.id},init:function(){if(!this.config.resolver)this.config.resolver=this.defaultResolver},get:function(a){a.url=this.config.url;this.fireEvent("onBeforeRequest",this,a)!==false&&this.handleRequest({type:a.method,url:a.url,data:a.filter||{}},this._onDone.bind(this,a))},handleRequest:function(a,
b){var c={success:true,data:[]};$.each(this.config.dataSet,function(b,e){this.config.resolver(a,e)&&c.data.push(e)}.bind(this));b(c)},_onDone:function(a,b){(a.onSuccess||$JSKK.emptyFunction)(b)}});$JSKK.Class.create({$namespace:"framework.data.proxy",$name:"MemoryProxy",$extends:framework.data.proxy.AbstractProxy})({},{raw:function(a){this.fireEvent("onBeforeRequest",this,a)!==false&&this._onDone(a)},sync:function(a){this.fireEvent("onBeforeRequest",this,a)!==false&&this._onDone(a)},_onDone:function(a){(a.onSuccess||$JSKK.emptyFunction)({})}});$JSKK.Class.create({$namespace:"framework.data.stateful",$name:"Store",$extends:framework.data.SingleModelStore})({ACCESS_PRIVATE:"private",ACCESS_PUBLIC:"public",LOCK_NONE:"none",LOCK_READONLY:"readonly",LOCK_FULL:"full"},{events:{onBeforeChange:true,onChange:true,onReady:true},ready:false,readyViews:[],stateMap:{},lockState:"none",keys:[],init:function(){this.model=framework.mvc.stateful.Model;this.init.$parent();var a=this.$reflect("self"),b=null;for(b in this.record.get(a.ACCESS_PRIVATE))this.stateMap[b]=
a.ACCESS_PRIVATE;for(b in this.record.get(a.ACCESS_PUBLIC))this.stateMap[b]=a.ACCESS_PUBLIC},canManageStateItem:function(a){return this.stateMap[a]==this.$reflect("self").ACCESS_PUBLIC},set:function(a,b){if(this.lockState==framework.data.stateful.Store.LOCK_NONE){var c=this.stateMap[a];this.record.get(c)[a]=b;c==this.$reflect("self").ACCESS_PUBLIC&&(c={},c[a]=b,this.getStateMgr().updateState(c,true));if(this.fireEvent("onBeforeChange",this,a,b)!==false)this.fireEvent("onChange",this,a,b);else return false}else throw Error('Store "'+
this.$reflect("name")+'" is in lock state "'+this.lockState+'" and so cannot be modified.');return this},setReady:function(a){if(this.ready=a){var a=this.getStateMgr().getState(),b;for(b in a)for(var c in this.state)if(c==b){this.state[c]=a[b];break}this.fireEvent("onReady",this)}return this},isReady:function(){return this.ready},get:function(a){return this.get.$parent(this.stateMap[a])[a]},setViewReady:function(a){this.readyViews.push(a);return this},getReadyViews:function(){return this.readyViews},
lock:function(a){if(["none","readonly","full"].inArray(a))this.lockState=a;else throw Error('"'+a+'" is an invalid lock type. Valid locks are "none", "readonly" and "full".');return this}});$JSKK.Class.create({$namespace:"framework.mvc",$name:"Controller",$uses:[framework.trait.ComponentConnector,framework.trait.signal.Receive,framework.trait.signal.Send,$JSKK.trait.Observable]})({},{events:{},init:function(){},onReconfigure:$JSKK.emptyFunction,onViewReady:$JSKK.emptyFunction,onGotBaseHTML:$JSKK.emptyFunction,onReadyState:$JSKK.emptyFunction});$JSKK.Class.create({$namespace:"framework.mvc",$name:"Model",$uses:[$JSKK.trait.Observable]})({LOCK_NONE:"none",LOCK_READONLY:"readonly",LOCK_FULL:"full"},{events:{onSync:true,onFailedSync:true,onChange:true,onLockChange:true},dirty:false,phantom:false,_clone:false,idField:"id",fields:[],record:{},store:null,lockState:"none",init:function(a){if(Object.isDefined(a)){this.record=Object.clone(this.fields);for(var b in this.fields)Object.isDefined(a[b])&&(this.record[b]=a[b])}else for(b in this.fields)this.record[b]=
this.fields[b]},bindStore:function(a){this.store=a;return this},unbindStore:function(){this.store=null;return this},getStore:function(){return this.store},sync:function(a){var b=this.getStore().getProxy();if(Object.isFunction(b.sync))b.sync({data:this.isDirty()?this.record:{},onSuccess:function(b){if(Object.isDefined(b.data))this.record=b.data;if(this.isClone()){if(Object.isFunction(a.onSuccess))a.onSuccess()}else this.fireEvent("onSync",this),this.fireEvent("onChange",this)}.bind(this),onFailure:function(){if(this.isClone()){if(Object.isFunction(a.onFailure))a.onFailure()}else this.fireEvent("onFailedSync",
this)}.bind(this)}),this.flagClean();else throw Error('The model "'+this.$reflect("namespace")+"."+this.$reflect("name")+'" cannot be synced as it does not have a syncable proxy attached to its bound store.');return this},get:function(a){if(this.lockState==framework.mvc.Model.LOCK_NONE||this.lockState==framework.mvc.Model.LOCK_READONLY||this.isClone())return this.record[a];else throw Error('The model "'+this.$reflect("namespace")+"."+this.$reflect("name")+'" is in a lock state that prevents reading.');
},getRecord:function(){if(this.lockState==framework.mvc.Model.LOCK_NONE||this.lockState==framework.mvc.Model.LOCK_READONLY||this.isClone())return this.record;else throw Error('The model "'+this.$reflect("namespace")+"."+this.$reflect("name")+'" is in a lock state that prevents reading.');},getId:function(){return Object.isString(this.idField)?this.get(this.idField):null},set:function(){if(this.lockState==framework.mvc.Model.LOCK_NONE||this.isClone()){var a=$JSKK.toArray(arguments),b={};Object.isDefined(a[1])?
b[a.shift()]=a.shift():b=a.shift();for(var c in b)this.record[c]=b[c];this.flagDirty()}else throw Error('The model "'+this.$reflect("namespace")+"."+this.$reflect("name")+'" is in a lock state that prevents any modification.');this.lockState==framework.mvc.Model.LOCK_NONE&&!this.isClone()&&this.fireEvent("onChange",this)},flagDirty:function(){this.dirty=true;return this},flagClean:function(){this.dirty=false;return this},isDirty:function(){return this.dirty},isClean:function(){return!this.dirty},
lock:function(a,b){if(["none","readonly","full"].inArray(a))this.lockState=a,b!==true&&!this.isClone()&&this.fireEvent("onLockChange",this,this.lockState);else throw Error('"'+a+'" is an invalid lock type. Valid locks are "none", "readonly" and "full".');return this},clone:function(){var a=new (this.$reflect("self"))({},this.record);a._clone=true;return a},isClone:function(){return this._clone},attachPhantom:function(a){this.phantom=a;return this},hasPhantom:function(){return Boolean(this.phantom)},
getPhantom:function(){if(this.hasPhantom())return this.phantom;else throw Error('The model "'+this.$reflect("namespace")+"."+this.$reflect("name")+'" does not have a phantom model associated with it.');},destroyPhantom:function(){delete this.phantom;this.phantom=null;return this}});$JSKK.Class.create({$namespace:"framework.mvc",$name:"View",$abstract:true,$uses:[framework.trait.ComponentConnector,framework.trait.signal.Bindable,$JSKK.trait.Observable]})({},{events:{onTemplatesLoaded:true,onReady:true,onShow:true,onHide:true},_ready:false,_stateBindings:{},templates:{},element:null,stateStore:null,init:function(){var a=this.getParentComponent();$JSKK.when(a.isConfigured.bind(a)).isTrue(function(){this.fetchTemplateContent(function(){(this.stateStore=this.getStore("State"))&&
this.stateStore.observe("onChange",this.onStateChange.bind(this));this._ready=true;this.onReady();this.fireEvent("onReady",this)}.bind(this))}.bind(this))},fetchTemplateContent:function(a){var b=0,c=0,d;for(d in this.templates)b++;for(d in this.templates){var e=this.$reflect("namespace").replace(/\./g,"/")+"/html/"+this.templates[d];!this.getViewCache().exists(e)||this.getViewCache().isFetching(e)?this.getViewCache().isFetching(e)?$PWT.when(function(){return this.getViewCache().isFetching(e)}.bind(this)).isFalse(function(a,
b){this.templates[b]=this.getViewCache().get(a);c++}.bind(this,e,d)):(this.getViewCache().setFetching(e),$.get(e,function(a,b,d){this.getViewCache().set(a,d);this.templates[b]=d;c++}.bind(this,e,d))):(this.templates[d]=this.getViewCache().get(e),c++)}$JSKK.when(function(){return b==c}).isTrue(function(){this.fireEvent("onTemplatesLoaded",this);a()}.bind(this))},getTemplate:function(a){return this.templates[a]},onReady:$JSKK.emptyFunction,onViewInit:$JSKK.emptyFunction,onStoreChange:$JSKK.emptyFunction,
syncView:$JSKK.Class.ABSTRACT_METHOD,bindDOMEvents:$JSKK.Class.ABSTRACT_METHOD,getContainerClass:function(){return"."+this.getSafeID()},getContainer:function(){return $("#"+this.getIID())},show:function(){this.getContainer().show();this.fireEvent("onShow",this);return this},hide:function(){this.getContainer().hide();this.fireEvent("onHide",this);return this},bindContainerEvent:function(a,b,c,d){return this.bindDOMEvent(a,null,b,c,d)},bindDOMEvent:function(a,b,c,d,e){var f=c.split(":");if(f.length==
2)switch(f[0]){case "controller":f=this.getController(f[1]);break;case "view":f=this}else f=this.getController(c);if(Object.isArray(b))$(b[0],this.getContainer()).on(a,b[1],e,f[d].bind(f));else this.getContainer().on(a,b,e,f[d].bind(f));return this},bindBodyDOMEvent:function(a,b,c,d,e){var f=c.split(":");if(f.length==2)switch(f[0]){case "controller":f=this.getController(f[1]);break;case "view":f=this}else f=this.getController(c);$("body").on(a,b,e,f[d].bind(f));return this}});$JSKK.Class.create({$namespace:"framework.mvc",$name:"ViewCache"})({FETCHING:"~*~FETCHING~*~"},{cache:{},set:function(a,b){this[String(a)]=String(b);return this},get:function(a){return this[String(a)]||""},exists:function(a){return Object.isDefined(this[String(a)])},setFetching:function(a){this[String(a)]=framework.mvc.ViewCache.FETCHING;return this},isFetching:function(a){return this[String(a)]===framework.mvc.ViewCache.FETCHING}});$JSKK.Class.create({$namespace:"framework.mvc.stateful",$name:"Controller",$abstract:true,$uses:[framework.trait.ComponentConnector,framework.trait.signal.Receive,framework.trait.signal.Send,framework.trait.signal.Bindable,$JSKK.trait.Observable]})({},{events:{onBeforeReadyState:true,onReadyState:true},stateStore:null,onBeforeChange:$JSKK.Class.ABSTRACT_METHOD,init:function(){this.registerSignals({onStateChangeFromStateMgr:framework.Signal.STATE_CHANGE});if(!(this.stateStore=this.getStore("State")))throw Error('Unable to initialize "'+
this.$reflect("namespace")+"."+this.$reflect("name")+'" State Controller. Controller requires a state model.');this.stateStore.observe("onBeforeChange",this.onBeforeChange.bind(this));this.stateStore.observe("onChange",this.onStateChange.bind(this))},onStateChangeFromStateMgr:function(a){if(this.stateStore.isReady()){var a=a.getBody(),b;for(b in a)if(this.stateStore.canManageStateItem(b)){var c=this.stateStore.get(b);if(!this.stateStore.set(b,a[b])){var d={};d[b]=c;this.getStateMgr().updateState(d,
true)}}}},onViewReady:$JSKK.emptyFunction,setReady:function(){this.stateStore.setReady(true);if(this.fireEvent("onBeforeReadyState",this,true)!==false){var a=this.getStateMgr().getState(),b;for(b in a)if(this.stateStore.canManageStateItem(b)){var c=this.stateStore.get(b);if(!this.stateStore.set(b,a[b])){var d={};d[b]=c;this.getStateMgr().updateState(d,true)}}this.fireEvent("onReadyState",this,true)}return this},updateState:function(a,b){this.stateStore.set(a,b);return this},setViewReadyState:function(a){this.stateStore.setViewReady(a);
return this},getReadyViews:function(){return this.stateStore.getReadyViews()}});$JSKK.Class.create({$namespace:"framework.mvc.stateful",$name:"Model",$extends:framework.mvc.Model})({},{fields:{"private":{},"public":{}}});$JSKK.Trait.create({$namespace:"framework.trait",$name:"ComponentConnector"})({init:function(a){this._component=a},getParentComponent:function(){return this._component},getCmpName:function(){return this.getParentComponent().my.name},getRadioTower:function(){return this.getParentComponent().radioTower},getStateMgr:function(){return this.getParentComponent().stateMgr},getID:function(){return this.$reflect("namespace")+"."+this.$reflect("name")},getSafeID:function(){return this.getParentComponent().getSafeID(cmp)},
getCmp:function(a){return this.getParentComponent().getCmp(a)},getStore:function(a){return this.getParentComponent().getStore(a)},getController:function(a){return this.getParentComponent().getController(a)},getView:function(a){return this.getParentComponent().getView(a)},getViewCache:function(){return this.getParentComponent().getViewCache()},getConfig:function(a){return this.getParentComponent().getConfig(a)},getIID:function(){return this.getParentComponent().getIID()},makeAttachPoint:function(a){return[this.getConfig("attachTo"),
a].join(" ")}});$JSKK.Trait.create({$namespace:"framework.trait.signal",$name:"Bindable"})({bindStatefulClick:function(){var a=$JSKK.toArray(arguments);$JSKK.when(this,"_ready").isTrue(function(){for(var b=null,c=0,d=a.length;c<d;c++){var b=this.getContainer(),e=$(a[c][0]),b=e[0]==b[0]?e:$(a[c][0],b);b.length&&this.getStateMgr().registerStateChanger(b,a[c][1])}}.bind(this));return this},bindStateChanges:function(a){if(Object.isUndefined(this._stateBindings))this._stateBindings={};for(var b in a)if(Object.isFunction(this[a[b]]))this._stateBindings[b]=
this[a[b]].bind(this);else throw Error('Unable to bind state change event for stateful property "'+b+'" because the method "'+a[b]+'" has not been defined on view class "'+this.$reflect("namespace")+"."+this.$reflect("name")+"");return this},onStateChange:function(a,b,c){if(Object.isUndefined(this._stateBindings))this._stateBindings={};if(Object.isFunction(this._stateBindings[b]))this._stateBindings[b](c)}});$JSKK.Trait.create({$namespace:"framework.trait.signal",$name:"Receive"})({registerSignals:function(a){for(var b in a)if(Object.isFunction(this[b]))if(Object.isAssocArray(a[b]))if(Object.isDefined(a[b].signal))Object.isDefined(a[b].filter)||Object.isDefined(a[b].type)?this.getRadioTower().observe(a[b].signal,function(b,d){if(d.isForMe(a[b].type||null,a[b].filter||null))return this[b](d)}.bind(this,b)):this.getRadioTower().observe(a[b].signal,this[b].bind(this));else throw Error("Signal not defined for registerSignals.");
else this.getRadioTower().observe(a[b],this[b].bind(this));else throw Error('Attempt to bind signal to undefined callback "'+b+'".');},registerSignalOnce:function(a,b){if(!Object.isFunction(b))if(Object.isFunction(this[b]))b=this[b];else throw Error('Attempt to bind signal to undefined callback "'+b+'".');this.getRadioTower().observeOnce(a,function(a){var d=a.getBody();if(d.id==this.getID()||d.component==this.getCmpName())return b(a)}.bind(this))}});$JSKK.Trait.create({$namespace:"framework.trait.signal",$name:"Send"})({sendSignal:function(a,b,c,d){console.debug(this.$reflect("namespace")+"."+this.$reflect("name"),":: sendSignal(trait) :: ",a);if(Object.isEmpty(a))throw Error("Class "+this.$reflect("name")+" attempted to fire an empty signal.");else return Object.isUndefined(c)&&(c={}),c.origin=Object.isFunction(this.getIID)?this.getIID():this.$reflect("namespace")+"."+this.$reflect("name"),this.getRadioTower().fireEvent(a,new framework.Signal({name:a,
body:d,type:b,filter:c}))},sendLocalSignal:function(){},sendGlobalSignal:function(){}});